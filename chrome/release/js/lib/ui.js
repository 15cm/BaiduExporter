!function(){"use strict";function t(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function a(e,n){for(var t=0;t<n.length;t++){var a=n[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function i(e,n,t){return n&&a(e.prototype,n),t&&a(e,t),e}function s(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function r(e,n){return(r=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e})(e,n)}function c(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var e=function(){function e(){t(this,e),this._listeners={}}return i(e,[{key:"on",value:function(e,n){(this._listeners[e]=this._listeners[e]||[]).push(n)}},{key:"trigger",value:function(e,n){(this._listeners[e]||[]).forEach(function(e){return e(n)})}},{key:"off",value:function(e){delete this._listeners[e]}}]),e}(),l=new(function(){function n(){var e;return t(this,n),(e=function(e,n){return!n||"object"!=typeof n&&"function"!=typeof n?c(e):n}(this,o(n).call(this))).defaultRPC=[{name:"ARIA2 RPC",url:"http://localhost:6800/jsonrpc"}],e.defaultUserAgent="netdisk;6.0.0.12;PC;PC-Windows;10.0.16299;WindowsBaiduYunGuanJia",e.defaultReferer="https://pan.baidu.com/disk/home",e.defaultAppId=250528,e.defaultConfigData={rpcList:e.defaultRPC,configSync:!1,md5Check:!1,fold:0,interval:300,downloadPath:"",userAgent:e.defaultUserAgent,referer:e.defaultReferer,appId:e.defaultAppId,headers:""},e.configData={},e.on("initConfigData",e.init.bind(c(e))),e.on("setConfigData",e.set.bind(c(e))),e.on("clearConfigData",e.clear.bind(c(e))),e}return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&r(e,n)}(n,e),i(n,[{key:"init",value:function(){var n=this;chrome.storage.sync.get(null,function(n){function e(e){chrome.storage.local.set({key:n[e]},function(){console.log("chrome first local set: %s, %s",e,n[e])})}for(var t in n)e(t)}),chrome.storage.local.get(null,function(e){n.configData=Object.assign({},n.defaultConfigData,e),n.trigger("updateView",n.configData)})}},{key:"getConfigData",value:function(e){var n=0<arguments.length&&void 0!==e?e:null;return n?this.configData[n]:this.configData}},{key:"set",value:function(e){this.configData=e,this.save(e),this.trigger("updateView",e)}},{key:"save",value:function(n){function e(e){chrome.storage.local.set(s({},e,n[e]),function(){console.log("chrome local set: %s, %s",e,n[e])}),!0===n.configSync&&chrome.storage.sync.set(s({},e,n[e]),function(){console.log("chrome sync set: %s, %s",e,n[e])})}for(var t in n)e(t)}},{key:"clear",value:function(){chrome.storage.sync.clear(),chrome.storage.local.clear(),this.configData=this.defaultConfigData,this.trigger("updateView",this.configData)}}]),n}()),u=new(function(){function e(){t(this,e),this.cookies={}}return i(e,[{key:"httpSend",value:function(e,n,t){var a=e.url,i=e.options;fetch(a,i).then(function(e){e.ok?e.json().then(function(e){n(e)}):t(e)}).catch(function(e){t(e)})}},{key:"getConfigData",value:function(e){var n=0<arguments.length&&void 0!==e?e:null;return l.getConfigData(n)}},{key:"objectToQueryString",value:function(n){return Object.keys(n).map(function(e){return"".concat(encodeURIComponent(e),"=").concat(encodeURIComponent(n[e]))}).join("&")}},{key:"sendToBackground",value:function(e,n,t){chrome.runtime.sendMessage({method:e,data:n},t)}},{key:"showToast",value:function(e,n){window.postMessage({type:"showToast",data:{message:e,type:n}},location.origin)}},{key:"getHashParameter",value:function(e){var n=window.location.hash.substr(1);return new URLSearchParams(n).get(e)}},{key:"formatCookies",value:function(){var e=[];for(var n in this.cookies)e.push("".concat(n,"=").concat(this.cookies[n]));return e.join("; ")}},{key:"getHeader",value:function(e){var n=0<arguments.length&&void 0!==e?e:"RPC",t=[];t.push("User-Agent: ".concat(this.getConfigData("userAgent"))),t.push("Referer: ".concat(this.getConfigData("referer"))),0<Object.keys(this.cookies).length&&t.push("Cookie: ".concat(this.formatCookies()));var a=this.getConfigData("headers");return a&&a.split("\n").forEach(function(e){t.push(e)}),"RPC"===n?t:"aria2Cmd"===n?t.map(function(e){return"--header ".concat(JSON.stringify(e))}).join(" "):"aria2c"===n?t.map(function(e){return" header=".concat(e)}).join("\n"):"idm"===n?t.map(function(e){var n=e.split(": ");return"".concat(n[0].toLowerCase(),": ").concat(n[1])}).join("\r\n"):void 0}},{key:"parseURL",value:function(e){var n=new URL(e),t=n.username?"".concat(n.username,":").concat(decodeURI(n.password)):null;t&&(t.includes("token:")||(t="Basic ".concat(btoa(t))));var a=n.hash.substr(1),i={},s=new URLSearchParams(a),o=!0,r=!1,c=void 0;try{for(var l,u=s[Symbol.iterator]();!(o=(l=u.next()).done);o=!0){var d=l.value;i[d[0]]=2===d.length?d[1]:"enabled"}}catch(e){r=!0,c=e}finally{try{o||null==u.return||u.return()}finally{if(r)throw c}}return{authStr:t,path:n.origin+n.pathname,options:i}}},{key:"generateParameter",value:function(e,n,t){e&&e.startsWith("token")&&t.params.unshift(e);var a={url:n,options:{method:"POST",headers:{"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"},body:JSON.stringify(t)}};return e&&e.startsWith("Basic")&&(a.options.headers.Authorization=e),a}},{key:"getVersion",value:function(e,n){var t=this.parseURL(e),a=t.authStr,i=t.path;this.sendToBackground("rpcVersion",this.generateParameter(a,i,{jsonrpc:"2.0",method:"aria2.getVersion",id:1,params:[]}),function(e){n.innerText=e?"Aria2版本为: ".concat(e):"错误,请查看是否开启Aria2"})}},{key:"copyText",value:function(e){var n=document.createElement("textarea");document.body.appendChild(n),n.value=e,n.focus(),n.select();var t=document.execCommand("copy");n.remove(),t?this.showToast("拷贝成功~","success"):this.showToast("拷贝失败 QAQ","failure")}},{key:"requestCookies",value:function(e){var n=this;this.sendToBackground("getCookies",e,function(e){n.cookies=e})}},{key:"aria2RPCMode",value:function(e,n){var o=this,t=this.parseURL(e),r=t.authStr,c=t.path,l=t.options;n.forEach(function(e){var n={jsonrpc:"2.0",method:"aria2.addUri",id:(new Date).getTime(),params:[[e.link],{out:e.name,header:o.getHeader()}]},t=o.getConfigData("md5Check"),a=n.params[1],i=o.getConfigData("downloadPath");if(i&&(a.dir=i),t&&(a.checksum="md5=".concat(e.md5)),l)for(var s in l)a[s]=l[s];o.sendToBackground("rpcData",o.generateParameter(r,c,n),function(e){e?o.showToast("下载成功!赶紧去看看吧~","success"):o.showToast("下载失败!是不是没有开启Aria2?","failure")})})}},{key:"aria2TXTMode",value:function(e){var i=this,s=[],o=[],r=[],c=[],n="data:text/plain;charset=utf-8,";e.forEach(function(e){var n="aria2c -c -s10 -k1M -x16 --enable-rpc=false -o ".concat(JSON.stringify(e.name)," ").concat(i.getHeader("aria2Cmd")," ").concat(JSON.stringify(e.link)),t=[e.link,i.getHeader("aria2c")," out=".concat(e.name)].join("\n");i.getConfigData("md5Check")&&(n+=" --checksum=md5=".concat(e.md5),t+="\n checksum=md5=".concat(e.md5)),s.push(n),o.push(t);var a=["<",e.link,i.getHeader("idm"),">"].join("\r\n");r.push(a),c.push(e.link)}),document.querySelector("#aria2CmdTxt").value="".concat(s.join("\n")),document.querySelector("#aria2Txt").href="".concat(n).concat(encodeURIComponent(o.join("\n"))),document.querySelector("#idmTxt").href="".concat(n).concat(encodeURIComponent(r.join("\r\n")+"\r\n")),document.querySelector("#downloadLinkTxt").href="".concat(n).concat(encodeURIComponent(c.join("\n"))),document.querySelector("#copyDownloadLinkTxt").dataset.link=c.join("\n")}}]),e}());new(function(){function e(){var n=this;t(this,e),this.version="1.0.3",this.updateDate="2019/04/15",l.on("updateView",function(e){n.updateSetting(e),n.updateMenu(e)})}return i(e,[{key:"init",value:function(){this.addSettingUI(),this.addTextExport(),l.trigger("initConfigData")}},{key:"addMenu",value:function(e,n){e.insertAdjacentHTML(n,'\n      <div id="exportMenu" class="g-dropdown-button">\n        <a class="g-button">\n          <span class="g-button-right">\n            <em class="icon icon-download"></em>\n            <span class="text">导出下载</span>\n          </span>\n        </a>\n        <div id="aria2List" class="menu" style="z-index:50;">\n          <a class="g-button-menu" id="aria2Text" href="javascript:void(0);">文本导出</a>\n          <a class="g-button-menu" id="settingButton" href="javascript:void(0);">设置</a>\n        </div>\n      </div>');var t=document.querySelector("#exportMenu");t.addEventListener("mouseenter",function(){t.classList.add("button-open")}),t.addEventListener("mouseleave",function(){t.classList.remove("button-open")});var a=document.querySelector("#settingButton"),i=document.querySelector("#settingMenu");a.addEventListener("click",function(){i.classList.add("open-o")})}},{key:"resetMenu",value:function(){Array.from(document.querySelectorAll(".rpc-button")).forEach(function(e){e.remove()})}},{key:"updateMenu",value:function(e){this.resetMenu();var n=e.rpcList,t="";n.forEach(function(e){var n='<a class="g-button-menu rpc-button" href="javascript:void(0);" data-url='.concat(e.url,">").concat(e.name,"</a>");t+=n}),document.querySelector("#aria2List").insertAdjacentHTML("afterbegin",t)}},{key:"addTextExport",value:function(){var e=this;document.body.insertAdjacentHTML("beforeend",'\n      <div id="textMenu" class="modal export-menu">\n        <div class="modal-inner">\n          <div class="modal-header">\n            <div class="modal-title">文本导出</div>\n            <div class="modal-close">×</div>\n          </div>\n          <div class="modal-body">\n            <div class="export-menu-row">\n              <a class="export-menu-button" href="javascript:void(0);" id="aria2Txt" download="aria2c.down">存为Aria2文件</a>\n              <a class="export-menu-button" href="javascript:void(0);" id="idmTxt" download="idm.ef2">存为IDM文件</a>\n              <a class="export-menu-button" href="javascript:void(0);" id="downloadLinkTxt" download="link.txt">保存下载链接</a>\n              <a class="export-menu-button" href="javascript:void(0);" id="copyDownloadLinkTxt">拷贝下载链接</a>\n            </div>\n            <div class="export-menu-row">\n              <textarea class="export-menu-textarea" type="textarea" wrap="off" spellcheck="false" id="aria2CmdTxt"></textarea>\n            </div>\n          </div>\n        </div>\n      </div>');var n=document.querySelector("#textMenu"),t=n.querySelector(".modal-close"),a=n.querySelector("#copyDownloadLinkTxt");a.addEventListener("click",function(){u.copyText(a.dataset.link)}),t.addEventListener("click",function(){n.classList.remove("open-o"),e.resetTextExport()})}},{key:"resetTextExport",value:function(){var e=document.querySelector("#textMenu");e.querySelector("#aria2Txt").href="",e.querySelector("#idmTxt").href="",e.querySelector("#downloadLinkTxt").href="",e.querySelector("#aria2CmdTxt").value="",e.querySelector("#copyDownloadLinkTxt").dataset.link=""}},{key:"addSettingUI",value:function(){var e=this,n='\n      <div id="settingMenu" class="modal setting-menu">\n        <div class="modal-inner">\n          <div class="modal-header">\n            <div class="modal-title">导出设置</div>\n            <div class="modal-close">×</div>\n          </div>\n          <div class="modal-body">\n            <div class="setting-menu-message">\n              <label class="setting-menu-label orange-o" id="message"></label>\n            </div>\n            <div class="setting-menu-row rpc-s">\n              <div class="setting-menu-name">\n                <input class="setting-menu-input name-s" spellcheck="false">\n              </div>\n              <div class="setting-menu-value">\n                <input class="setting-menu-input url-s" spellcheck="false">\n                <a class="setting-menu-button" id="addRPC" href="javascript:void(0);">添加RPC地址</a>\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">配置同步</label>\n              </div>\n              <div class="setting-menu-value">\n                <input type="checkbox" class="setting-menu-checkbox configSync-s">\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">MD5校验</label>\n              </div>\n              <div class="setting-menu-value">\n                <input type="checkbox" class="setting-menu-checkbox md5Check-s">\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n               <div class="setting-menu-name">\n                 <label class="setting-menu-label">文件夹层数</label>\n               </div>\n               <div class="setting-menu-value">\n                 <input class="setting-menu-input small-o fold-s" type="number" spellcheck="false">\n                 <label class="setting-menu-label">(默认0表示不保留,-1表示保留完整路径)</label>\n               </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">递归下载间隔</label>\n              </div>\n              <div class="setting-menu-value">\n                <input class="setting-menu-input small-o interval-s" type="number" spellcheck="false">\n                <label class="setting-menu-label">(单位:毫秒)</label>\n                <a class="setting-menu-button version-s" id="testAria2" href="javascript:void(0);">测试连接，成功显示版本号</a>\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">下载路径</label>\n              </div>\n              <div class="setting-menu-value">\n                <input class="setting-menu-input downloadPath-s" placeholder="只能设置为绝对路径" spellcheck="false">\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">User-Agent</label>\n              </div>\n              <div class="setting-menu-value">\n                <input class="setting-menu-input userAgent-s" spellcheck="false">\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">Referer</label>\n              </div>\n              <div class="setting-menu-value">\n                <input class="setting-menu-input referer-s" spellcheck="false">\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">AppId</label>\n              </div>\n              <div class="setting-menu-value">\n                <input class="setting-menu-input app_id-s" spellcheck="false">\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">Headers</label>\n              </div>\n              <div class="setting-menu-value">\n                <textarea class="setting-menu-input textarea-o headers-s" type="textarea" spellcheck="false"></textarea>\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n          </div>\x3c!-- /.setting-menu-body --\x3e\n          <div class="modal-footer">\n            <div class="setting-menu-copyright">\n              <div class="setting-menu-item">\n                <label class="setting-menu-label">&copy; Copyright</label>\n                <a class="setting-menu-link" href="https://github.com/acgotaku/BaiduExporter" target="_blank">雪月秋水</a>\n              </div>\n              <div class="setting-menu-item">\n                <label class="setting-menu-label">Version: '.concat(this.version,'</label>\n                <label class="setting-menu-label">Update date: ').concat(this.updateDate,'</label>\n              </div>\n            </div>\x3c!-- /.setting-menu-copyright --\x3e\n            <div class="setting-menu-operate">\n              <a class="setting-menu-button large-o blue-o" id="apply" href="javascript:void(0);">应用</a>\n              <a class="setting-menu-button large-o" id="reset" href="javascript:void(0);">重置</a>\n            </div>\n          </div>\n        </div>\n      </div>');document.body.insertAdjacentHTML("beforeend",n);var t=document.querySelector("#settingMenu");t.querySelector(".modal-close").addEventListener("click",function(){t.classList.remove("open-o"),e.resetSetting()}),document.querySelector("#addRPC").addEventListener("click",function(){var e=document.querySelectorAll(".rpc-s");Array.from(e).pop().insertAdjacentHTML("afterend",'\n        <div class="setting-menu-row rpc-s">\n          <div class="setting-menu-name">\n            <input class="setting-menu-input name-s" spellcheck="false">\n          </div>\n          <div class="setting-menu-value">\n            <input class="setting-menu-input url-s" spellcheck="false">\n          </div>\n        </div>\x3c!-- /.setting-menu-row --\x3e')});var a=document.querySelector("#apply"),i=document.querySelector("#message");a.addEventListener("click",function(){e.saveSetting(),i.innerText="设置已保存"}),document.querySelector("#reset").addEventListener("click",function(){l.trigger("clearConfigData"),i.innerText="设置已重置"});var s=document.querySelector("#testAria2");s.addEventListener("click",function(){u.getVersion(l.getConfigData("rpcList")[0].url,s)})}},{key:"resetSetting",value:function(){document.querySelector("#message").innerText="",document.querySelector("#testAria2").innerText="测试连接，成功显示版本号"}},{key:"updateSetting",value:function(e){var n=e.rpcList,t=e.configSync,a=e.md5Check,i=e.fold,s=e.interval,o=e.downloadPath,r=e.userAgent,c=e.referer,l=e.appId,u=e.headers;Array.from(document.querySelectorAll(".rpc-s")).forEach(function(e,n){0!==n&&e.remove()}),n.forEach(function(e,n){var t=document.querySelectorAll(".rpc-s");if(0===n)t[n].querySelector(".name-s").value=e.name,t[n].querySelector(".url-s").value=e.url;else{var a='\n          <div class="setting-menu-row rpc-s">\n            <div class="setting-menu-name">\n              <input class="setting-menu-input name-s" value="'.concat(e.name,'" spellcheck="false">\n            </div>\n            <div class="setting-menu-value">\n              <input class="setting-menu-input url-s" value="').concat(e.url,'" spellcheck="false">\n            </div>\n          </div>\x3c!-- /.setting-menu-row --\x3e');Array.from(t).pop().insertAdjacentHTML("afterend",a)}}),document.querySelector(".configSync-s").checked=t,document.querySelector(".md5Check-s").checked=a,document.querySelector(".fold-s").value=i,document.querySelector(".interval-s").value=s,document.querySelector(".downloadPath-s").value=o,document.querySelector(".userAgent-s").value=r,document.querySelector(".referer-s").value=c,document.querySelector(".app_id-s").value=l,document.querySelector(".headers-s").value=u}},{key:"saveSetting",value:function(){var e=document.querySelectorAll(".rpc-s"),n={rpcList:Array.from(e).map(function(e){var n=e.querySelector(".name-s").value,t=e.querySelector(".url-s").value;if(n&&t)return{name:n,url:t}}).filter(function(e){return e}),configSync:document.querySelector(".configSync-s").checked,md5Check:document.querySelector(".md5Check-s").checked,fold:Number.parseInt(document.querySelector(".fold-s").value),interval:document.querySelector(".interval-s").value,downloadPath:document.querySelector(".downloadPath-s").value,userAgent:document.querySelector(".userAgent-s").value,referer:document.querySelector(".referer-s").value,appId:document.querySelector(".app_id-s").value,headers:document.querySelector(".headers-s").value};l.trigger("setConfigData",n)}}]),e}())}();